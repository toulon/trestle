var <%=model.singularCapitalized%> = require('<%=model.relativeRootPath%>/models/<%=model.path%>'),
    mapper = require('../lib/model-mapper'),
    forms = require('forms-bootstrap/lib/forms');

var fields = forms.fields,
  validators = forms.validators,
  widgets = forms.widgets;

module.exports = function(app) {
var form = forms.create({
<% for(var i in properties) { -%>
<%=properties[i].name%>: fields.<%=properties[i].schemaType.toLowerCase() -%> ({
    label: '<%= properties[i].nameCapitalized %>'
}),
<% } -%>
})

  app.param('<%=model.singular%>Id', function(req, res, next, id) {
    <%=model.singularCapitalized%>.findById(id, function(err, <%=model.singular%>) {
      if (err) {
        next(err);
      } else {
        res.locals.<%=model.singular%> = <%=model.singular%>;
        next();
      }
    });
  });
  
  app.get('<%=model.route%>', function(req, res) {
    <%=model.singularCapitalized%>.find({}, function(err, <%=model.plural%>) {
      res.render('<%=model.path%>/index', { <%=model.plural%> : <%=model.plural%> });
    });
  });

  app.get('<%=model.route%>/create', function(req, res) {
      res.render('<%=model.path%>/create', {
      <%=model.singular%> : new <%=model.singularCapitalized%>(),
      title : '<%=model.pluralCapitalized%>',
      form: form.toHTML()
    });
  });

  app.post('<%=model.route%>/create', function(req, res) {
    form.handle(req, {
      success: function (form) {
        var <%=model.singular%> = new <%=model.singularCapitalized%>(req.body);
        <%=model.singular%>.save(function(err) {
        if (err) {
          res.render('<%=model.path%>/create', {
            title: '<%=model.pluralCapitalized%>',
            form: form.toHTML()
          });
        } else {
          res.redirect('<%=model.route%>');
        }
      });
        },
        other: function (form) {
          res.render('/<%=model.path%>', {
            title: 'Failed!',
            form: form.toHTML()
          });
        }
    });
  });

  app.get('<%=model.route%>/:<%=model.singular%>Id/edit', function(req, res) {
    form.bind(res.locals.<%=model.path%>);
    res.render('<%=model.path%>/edit', {
      title : '<%=model.pluralCapitalized%>',
      form: form.toHTML()
    });
  });

  app.post('<%=model.route%>/:<%=model.singular%>Id/edit', function(req, res) {
    mapper.map(req.body).to(res.locals.<%=model.path%>);
    form.handle(res.locals.<%=model.path%>, {
      success: function (form) {
        console.log("Success")
      },
      other: function (form) {
        console.log("Failure")
      }
    });
    res.locals.<%=model.singular%>.save(function(err) {
      if (err) {
        res.render('<%=model.path%>/edit', {
          title: '<%=model.pluralCapitalized%>',
          form: form.toHTML()
        });
      } else {
        res.redirect('<%=model.route%>');
      }
    });
  });

  app.get('<%=model.route%>/:<%=model.singular%>Id/detail', function(req, res) {
    res.render('<%=model.path%>/detail');
  });

  app.get('<%=model.route%>/:<%=model.singular%>Id/delete', function(req, res) {
    res.render('<%=model.path%>/delete');
  });

  app.post('<%=model.route%>/:<%=model.singular%>Id/delete', function(req, res) {
    <%=model.singularCapitalized%>.remove({ _id : req.params.<%=model.singular%>Id }, function(err) {
      res.redirect('<%=model.route%>');
    });
  });
}

// Used to build the index page. Can be safely removed!
module.exports.meta = {
  name : '<%=model.singularCapitalized%>',
  route : '<%=model.route%>'
}
